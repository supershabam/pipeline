package pipeline

import (
	"io"
	"text/template"
)

const maxSizeBatch = `// AUTOMATICALLY GENERATED FILE - DO NOT EDIT
// generated by pipeliner@v{{.Version}}
package {{.Package}}

// assuming no imports for now

// {{.FuncName}} was generated by pipeliner automatically on {{.Timestamp}}
func {{.FuncName}}(maxSize int, in <-chan {{.Type}}) <-chan []{{.Type}} {
  if maxSize <= 0 {
    panic("batch size must be greater than zero")
  }
  out := make(chan []{{.Type}})
  go func() {
    defer close(out)
  Start:
    batch := []{{.Type}}{}
    for {
      if len(batch) >= maxSize {
        out <- batch
        goto Start
      }
      item, active := <-in
      if !active {
        if len(batch) > 0 {
          out <- batch
        }
        return
      }
      batch = append(batch, item)
    }
  }()
  return out
}
`

var (
	maxSizeBatchT = template.Must(template.New("maxSizeBatch").Parse(maxSizeBatch))
)

// BatchConfig is the template variables for maxSizeBatch
type BatchConfig struct {
	Package   string
	FuncName  string
	Type      string
	Timestamp string
	Version   string
}

// RenderBatch renders a maxSizeBatch function
func RenderBatch(wr io.Writer, c BatchConfig) error {
	return maxSizeBatchT.Execute(wr, c)
}
